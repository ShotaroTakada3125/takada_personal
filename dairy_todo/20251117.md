# adamas MTGメモ

日時:2025/11/17 14:00~
- データ分析基盤側の試験に関するテーブル挿入
    - 今日明日はテーブルへの追加を0にする必要がある
    - であれば今日明日はJMeterの実行ができない
    - todo：下に示すやつは今日中は対応が必要
        - エビデンスの取得・整理
        - JMeter実行準備


- データ分析基盤の優先度が高い
    - エビデンス
        - エラーが出始める前後の枯渇、エラーがないことはJMeterの結果
        - 100に張り付いてない負荷、アプリで
        - 原因でエラー, 
        期限叩けないのであれば
        エビデンスをまとめる
        アプリ側のエラーログを見ながら、エラーの仮説を立てる
        期限は今週中に再打鍵までできたら良い
        原因の特定は二人に出してもらいたいのではなく、簡単な仮説
            DBの負荷が上がり、DBの負荷が上がっているので調査を依頼するバトンを渡す調査まで
        段階を細かくして週の後半
        300が限界っぽい


- コネクションプール数
    - 前回実行した際はmax_poolsizeが400ではなく10だったっぽい
    - RDSのCPU使用率はmaximam_poolsizeには関係がなさそう
- 六本木さん状況
    - ソースを追っている
    - インデックスが貼られてないクエリが存在した
    - 11/16 実行時350RPS以上だとエラーが発生した理由はmaximau PoolSizeが低く、アプリ側で止まってしまっていたのではないか
- 口座開設
    - 1s100件はプール数が1600ほど必要になってしまうので、現在のプール数200の設定ではアプリ側で止まってしまう
    - 10s100件ならプール数の必要数が160ほどになり、プール数は問題にならないと考えられる。
    - DBのクエリ実行が遅くなっている原因
        - 直列にループしている部分?
        - シンクロナイズドの部分?
- 実行結果
    - 口座開設：メールアドレス登録のみ
        - 10s100件でもエラーが発生した。
        - Response timeも件数とともに増加しており、局所的な負荷に耐えられていないことを示している。
        - 上記のように、pool sizeには問題がないことを確認しており、



## 調査のために必要なこと
### 収集する情報
- 性能試験結果の詳細
    - 発生したエラーコード
        - 502/Bad Gateway
        - 504/Gateway Time-out
        - 404/Not Found
    - エラーレスポンスの本文
        - 今回はリクエストとレスポンスを出力させる仕組みになっていなかったため省略
    - エラー発生時のリクエスト・レスポンス
        - 今回はリクエストとレスポンスを出力させる仕組みになっていなかったため省略
- 350RPS到達前後の統計情報
    - エラーが出始める直前のレスポンスタイムの推移
    - スループット(RPS)のグラフ
    - TSTで設定したスケジュールと、JMeterの実行結果としての実際のスループットに大きな乖離がないか
- AWS CloudWatchメトリクスの収集
    - ALB
        - HTTPCode_Target_5XX_Count
        - TargetConnectionErrorCount
    - ECS(アプリケーションサーバー)
        - frontendはmax43%程度だが、実行が終了した段階でCPU使用率, メモリが途切れている
        - frontend
            - CPU使用率:max45%
            - メモリ使用率:max25%
        - api
            - CPU使用率:max20%
            - メモリ使用率:max25%
    - RDS
        - CPU利用率
        - Database Connections
    - ElastiCache
        - Cache Hits/Misses
    - CloudWatch ログ
        - 実行したクエリ
        ```
        fields @timestamp, @message, @logStream, @log
        | filter @message like /(?i)Error/
        | sort @timestamp desc
        | limit 10000
        ```

- 仮説と補足
    - DB接続の枯渇
        - アプリケーションサーバのDB接続プールの上限の可能性
    - 特定のリソースのロック
    - アプリケーションサーバのCPU限界
    - DBサーバのI/O限界


チャット文章

＜ここまでのまとめ＞
- JMeterで負荷試験を実施した際、アプリケーションコード内のバグが高負荷時に顕在化し、s25-signup-frontendサービスをクラッシュさせていたことが判明
- クラッシュの原因
    - [クラッシュログ](https://toiware-dev.slack.com/archives/C04QGMUBMK8/p1763446164848529?thread_ts=1763433635.859769&cid=C04QGMUBMK8):
    ```
    "message":"uncaughtException: Cannot read properties of null (reading 'familyName')"
    ```
    - 発生箇所: /app/server/functions/login.js:97:40
    - 発生時刻: 2025年11月16日 23:23:58 JST
    - 11/16 23:24にfrontendがタスクをDeregisteredし、再起動を開始している
    - => これにより負荷試験での502/504エラーが頻出
    - 原因ファイル
        - https://github.com/simon-arg/signup-frontend/blob/adamas/server/functions/login.js#L92
        - 84行目でAPIのエラーによりaccountDetailにnullが代入され、92行目でnullのためuncaughtExceptionが発生
- todo
    - login.jsにこちらと同じような対応をしてもらう
    - クラッシュを誘発したAPI(/account/{accountId}か/${customerType}/{accountId})の応答失敗の根本原因を調査
        - API側のログで、frontendからのリクエストに対し、エラーコード・レスポンスを確認
        - RDSのメトリクスを確認
        - （Trustdockの404エラーが大量に出ているのでそれが原因かどうかの確認）

＜ここまでのまとめ（別人作成）＞
- ログイン関連
    - front API /api/login - backend API GET /individual/${accountId} の中で、changerequest_individualをaccountIdでselectしている
        - => しかしaccount_idにindexが貼られていない(後述参考1)ため、テーブルのボリュームが大きい場合full scanになる可能性がある
        - => maximum-pool-size < リクエスト数となり滞留が発生。ALBのアイドルタイムアウト時間を超え5xx系エラー発生。
- 口座開設関連
    - 口座番号登録処理に synchronized が付与されていることで、並列なリクエストが直列化される。(後述 参考2)
    - => ECSタスク数が2つなので、maximum-pool-sizeによらず実質アプリから同時にDBに接続されているのは最大2つ
    - => API側で滞留(javaスレッドのロックが発生)し、ALBのアイドルタイムアウト時間を超え、5xx系エラー発生。
- trustdockの影響
    - trustdock関連のバッチ処理でDBアクセスが発生する場合そのコネクション数も加味する必要がある。
    - 口座開設のシナリオを大量に実行したことで、連携データ（DB登録対象データ？）が増え、コネクション数が増えている可能性がある
    - 推測が正しい場合、口座開設のどのステップまでいったらtrustdock連携データ？増加に影響するのか確認が必要
上記考えが正しいか、また正しい場合、なにかしら対応可能かアプリチームに確認必要
[参考1]
account_idにindexが張られていない
```
s25signup=> SELECT *
FROM pg_indexes
WHERE tablename = 'changerequest_individual';
 schemaname |        tablename         |           indexname           | tablespace |                                               indexdef

------------+--------------------------+-------------------------------+------------+---------------------------------------------------------------------------------
----------------------
 public     | changerequest_individual | changerequest_individual_pkey |            | CREATE UNIQUE INDEX changerequest_individual_pkey ON public.changerequest_indivi
dual USING btree (id)
(1 row)

s25signup=*>
```
[参考2]
https://toiware-dev.slack.com/archives/C07QJNKGPV3/p1762756982991619?thread_ts=1762504542.714009&cid=C07QJNKGPV3

＜直接話した時の会話内容＞
- ログイン系についてはこのままエスカレーションでOK
    - login.jsのnullの対応もエスカレーション(優先度については不明)
        - 今回は負荷をかけたことで顕現
        - 根本原因はインデックスがなかったこと
- 口座開設系についてもエスカレーションしてOK
    - 対応についてはチーム全体で決定
    - 前の永瀬さんの話では、外しても良いと思われるが、影響範囲が不明のため実行したくない
    - 解決のためには
        - クエリを早くする → 効率的なSQLへ変更
        - タスク数を増やす → 現在は2
        - メソッドの syncrhonized 修飾子を外す（こちら）
- trustdockの影響
    - APIのログにはこちらが大量に出ている
    - エラーメッセージを検索すると定期的に発生しており、バッチを実行しているタイミングでは？
    - このログについてはシステム上問題ない？
    - 六本木さんの推測
        - TrustDock口座開設時にユーザの情報が溜まり、それを定期バッチでDBに入れている?
        - DBへのアクセスが発生していると考えられ、量によってはconnectionを占めてしまう
        - 性能テストの設定(adamas-testブランチの設定)なのか、負荷をかけたことで発生しているのか聞く
- 我々のtodo
    - データ追加後JMeter実行
    - ログイン：ストレス試験
    - ログイン：同時セッション
    - エスカレーション事項をまとめて報告
    - 再実行したシナリオのエビデンス取得


依頼文章
ヒートラン中失礼します。性能テストで負荷試験を実施した際に、エラーが発生したのですがその原因調査をしました。調査内容のご確認と、発生した依頼事項の解決をしていただけますと幸いです。
1. signup-frontendのクラッシュ
- 高負荷時、Frontendサービスが処理不能なエラーでクラッシュし、ALBが502/504を返すという連鎖が発生した事象がありました。

- クラッシュの詳細
    - 事象：s25-signup-frontend-service が処理不能なエラー（uncaughtException）で強制終了し、タスクが再起動（Deregistered）しました。
    - [クラッシュログ](https://toiware-dev.slack.com/archives/C04QGMUBMK8/p1763446164848529?thread_ts=1763433635.859769&cid=C04QGMUBMK8):
        ```
        "message":"uncaughtException: Cannot read properties of null (reading 'familyName')"
        ```
    - 発生箇所: /app/server/functions/login.js:97:40
    - 発生時刻: 2025年11月16日 23:23:58 JST
    - 11/16 23:24にfrontendがタスクをDeregisteredし、再起動を開始している
    - => これにより負荷試験での502/504エラーが頻出
    - 原因ファイル
        - https://github.com/simon-arg/signup-frontend/blob/adamas/server/functions/login.js#L92
        - 84行目でAPIのエラーによりaccountDetailにnullが代入され、92行目でnullのためuncaughtExceptionが発生
- 依頼事項
    - login.jsの修正: [該当ファイル](https://github.com/simon-arg/signup-frontend/blob/adamas/server/functions/login.js#L92)を、こちらと同じように、accountDetail変数のnullチェックを追加していただけますと幸いです。
2. クラッシュの根本原因
    - ログイン関係
        - frontのAPI(/api/login)が読んでいるbackendのAPI GET(/individual/${accountId})がchangerequest_individualをaccountIdでselectしている[(ソースコード)](https://github.com/simon-arg/signup-api/blob/feature/adamas-test/src/main/java/com/bitargx/signup/api/service/IndividualAccountService.java#L84)
        - しかし、このaccount_idカラムにはインデックスが貼られていません。(後述 参考1)これによってテーブルのデータ量が増加した際にフルスキャンが発生し、クエリ応答時間が悪化し、スレッド滞留、ALBタイムアウトの原因になると推測しています。
    - 依頼事項
        - 上記認識相違ないことと、changerequest_individual テーブルの account_id にインデックスを貼る対応をしていただけますと幸いです。
3. 口座開設関
    - ログイン回りの処理ではないのですが、口座開設系の処理の中でボトルネックの原因となる箇所を整理したので、ご確認願いたいです。
        - 口座番号登録処理に synchronized が付与されていることで、並列なリクエストが直列化される。(後述 参考2)
        - => ECSタスク数が2つなので、maximum-pool-sizeによらず実質アプリから同時にDBに接続されているのは最大2つ
        - => API側で滞留(javaスレッドのロックが発生)し、ALBのアイドルタイムアウト時間を超え、5xx系エラー発生
    - 依頼事項
        - 対応方針について決定
            - 効率的なクエリに修正する、ECSタスク数を増やす、メソッドの syncrhonized 修飾子を外すなどがあると思いますが、どのような対応にするか、ご検討、ご対応いただけますと幸いです。
4. Trustdock/Batchの影響調査
    - ログイン系の負荷テストのログに、「trustdock-data not found (HTTP 404 WARN) 」のログが大量に発生しています。出ているタイミングが周期的のため、バッチ実行時に生じるログなのではないかと考えております。
    - 依頼事項
        - この大量のログについて、性能テストの設定(adamas-testブランチの設定)なのか、負荷をかけたことで発生しているのかご確認いただいてもよろしいでしょうか。
        - 仮に負荷をかけたことで発生している場合、対応可能なログでしょうか。

[参考1]
account_idにindexが張られていない
```
s25signup=> SELECT *
FROM pg_indexes
WHERE tablename = 'changerequest_individual';
 schemaname |        tablename         |           indexname           | tablespace |                                               indexdef

------------+--------------------------+-------------------------------+------------+---------------------------------------------------------------------------------
----------------------
 public     | changerequest_individual | changerequest_individual_pkey |            | CREATE UNIQUE INDEX changerequest_individual_pkey ON public.changerequest_indivi
dual USING btree (id)
(1 row)

s25signup=*>
```
[参考2]
https://toiware-dev.slack.com/archives/C07QJNKGPV3/p1762756982991619?thread_ts=1762504542.714009&cid=C07QJNKGPV3

